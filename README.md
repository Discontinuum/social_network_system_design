# Дизайн социальной сети для курса System Design

## Функциональные требования

* Добавление постов (с текстом + фотографиями + привязкой к месту)
* Добавление оценок к постам
* Добавление комментариев к постам
* Подписка на аккаунты других пользователей
* Поиск мест по популярности
* Поиск постов по месту
* Просмотр ленты пользователя, составленной из постов тех, на кого он подписан

## Нефункциональные требования

* DAU = 10 000 000
* Аудитория стран СНГ
* Данные храним всегда
* Сезонность: новогодние праздники (10 дней) + майские праздники (10 дней) + летний сезон отпусков (июль-август, примерно 60 дней). Всего 80 дней или около 22% года. Нагрузка будет возрастать в среднем на 30%, множитель 1,3.
* Лимиты:
    * Пользователь может иметь не более 500 подписок
    * Пользователь может отправлять посты не чаще 1 раза в пять минут (т.е. не более 288 (примерно 300) постов в день)
    * Пост может содержать не более 5 изображений весом не более 1Мб каждое и до 1 Кб текста. Привязка поста - только к одному месту
    * Комментарий может содержать не более 280 символов (560 байтов, если представим русский текст в UTF-8, в среднем 0,5 Кбайта)
    * Пользователь может оставлять не более 2 комментариев в минуту (2880 в день)
    * Пользователь может оставлять не более 60 оценок в минуту (86400 в сутки)
* Доступность
    * Новый пост/комментарий/реакция пользователя доходят до других пользователей за 3 секунды
    * Поиск постов по месту и выборка из ленты занимают не больше 1 секунды
    * Доступность 99,95% (не более 4 часов 23 минут простоя в год)
* Активность (предположительная):
    * Пользователь в среднем смотрит ленту 2 раза за сутки
    * За один просмотр ленты пользователь смотрит 10 постов и реагирует в среднем на половину из них. Всего за сутки 20 постов и 10 реакций
    * Постящие пользователи постят в среднем 1 раз в день
    * Комментирующие пользователи в среднем оставляют 5 комментариев в день
    
## Подсчёт нагрузки
Для подсчёта нагрузки будем опираться на правило 1-9-90 в редакции: 1% пользователей активно постят, 9% пользователей комментируют, 90% просто смотрят/реагируют.

### Нагрузка по ленте постов
RPS (read feed) по запросам конкретно ленты (по 10 последних постов в ней в среднем)

    RPS (read feed) = DAU * avg feed access per day / 86400
    RPS (read feed) = 10 000 000 * 2 / 86400 ≈ 231

Считаем, что ленту смотрят все

RPS (write) - запросы на создание нового поста
 
    RPS (write) = DAU * posters ratio * avg posts per day / 86400
    RPS (write) = 10 000 000 * 0.01 * 1 / 86400 = 10 000 0 / 86400 ≈ 1,2
    
    
Оценим траффик отдельно по медиа-данным и по метаданным

#### Посты: медиа-данные
Оценим размер поста по максимальному: 5Мб засчет 5 изображений по 1 Мб.

    Traffic (read media) = RPS (read feed) * avg posts in feed * media size = 231 reqs/sec * 10 * 5 Mb ≈ 11,3 Gb/sec
    Traffic (write media) = RPS (write) * post size = 1,2 reqs/sec * 5Mb = 6 Mb/sec
    
#### Посты: мета-данные
Пост может содержать 1 Кбайт текста, привязку к месту, возможно некоторые идентификаторы медиа-вложений (чтобы мы могли их с постом сопоставить), идентификатор пользователя. Положим это как 7 GUID'ов.

Получаем 1024B + 7 * 16B = 1136B мета-данных на пост.

Traffic (read meta) = RPS (read feed) * avg posts in feed * meta size = 231 reqs/sec * 10 * 1136B ≈ 2,5 Mb/sec
Traffic (write meta) = RPS (write) * post size = 1,2 reqs/sec * 1136B ≈ 1,3 Kb/sec

### Нагрузка по комментариям
Для упрощения считаем, что комментарии читают и пишут только 9%

    RPS = DAU * commenters ratio * avg comments / 86400
    RPS = 10 000 000 * 0.09 * 5 / 86400 = 4500000 / 86400 ≈ 52
    
Комментарий оценивался в 0,5 Кбайта объёма

    Traffic = RPS * avg size = 52 reqs/sec * 0.5 Kb = 26 Kb/sec

### Нагрузка по реакциям
    RPS (write) = DAU * avg reacts / 86400 = 10 000 000 * 10 / 86400 ≈ 1157

Информация о реакции: код реакции, id поста. Если представить их двумя GUID'ами (что может быть и избыточно), получим 32 B на реакцию

    Traffic (write) = RPS(write) * react size = 1157 * 32B ≈ 36,2 Kb/sec
    
# Оценка дисков

По каждой системе рассчитаем capacity за год, а также необходимые диски по throughput и iops.

## Посты: медиа-данные

Capacity = Traffic (write media) * 86400 * 365 = 6 Mb/sec * (86400 * 365) sec/year = 189216000 Mb / year ≈ 180,5 Tb/year. По годовой capacity требуется: 6 HDD, 2 SATA SSD максимального объёма, 6-7 nVME SSD. 

Traffic\_per\_second ≈ 11 Gb/sec: по дискам потребует 112 HDD, 23 SATA SSD, 4 nVME SSD

IOPS оценим как rps(write) + rps(read feed) * 10 posts * 5 media = 1,2 + 231 * 50 ≈ 11551. По дискам это потребует 116 HDD, 12 SATA SSD, 2 nVME SSD.

Оптимальным решением по итогу кажется 6-7 SSD nVME.
## Посты: мета-данные

Capacity = Traffic (write meta)  * 86400 * 365 = 1,3  * 86400 * 365 Kb/year ≈ 39,1 Gb/year

Traffic\_per\_second = 2,5 Mb/sec + 1,3 Kb/sec ≈ 3 Mb/sec

IOPS оценка прежняя: rps(write) + rps(read feed) * 10 posts * 5 media = 1,2 + 231 * 50 ≈ 11551. По дискам это потребует 116 HDD, 12 SATA SSD, 2 nVME SSD.

Вывод: 2 nVME SSD из-за требований по IOPS.

## Комментарии

Capacity = Traffic * 86400 * 365 = 26 Kb/sec  * (86400 * 365) sec/year  = 819936000 Kb/year ≈ 782 Gb/year

Traffic 26 Kb/sec, RPS = 52. Хватит одного HDD.

## Реакции

Capacity = Traffic (write) * 86400 * 365 = 36,2 * (86400 * 365)  Kb/year ≈ 1Tb/year.

RPS = 1157. Traffic ≈ 36,2 Kb/sec.

По IOPS RPS получаем: 11 HDD, 1-2 SATA SSD, 1 nVME SSD.

Вывод: берём 1-2 SATA SSD либо 1 nVME SSD, смотря что дешевле.

## Резюме

Медиа-данные постов (видимо S3 хранилище): 7 SSD nVME, либо же 12 SATA SSD

Мета данные постов: 2 nVME SSD

Комментарии: 1 HDD.

Реакции: 1-2 SATA SSD либо 1 nVME SSD

# Оценка хостов с репликацией

## Посты: медиа-данные

Медиа-данные постов асинхроннно реплицируем с RF=3. По хранению данных нам нужно 7 nVME SSD из-за объёма. По траффику же нужно 4 nVME. Можем охлаждать старые данные на HDD (большинство просмотров будет приходится на новые посты). На 4 nVME SSD храним недавние медиа, на 4 HDD храним старые посты, всего 8 дисков.

В каждый хост ставим по 2 диска, тогда

Hosts = 8/2 = 4

Hosts\_replicated = 4 * 3 = 12

## Посты: мета-данные

Нам хватает по объёму одного диска, чтение можно смасштабировать репликацией. Тогда ставим в каждый хост по 1 nVME SSD диску.

Хостов при RF = 3 будет 3.

## Комментарии

Три хоста с репликацией, в каждом по HDD

## Реакции

В реакциях большая нагрузка на запись, так что смасштабировать репликацией её не получится, берём по одному nVME SSD на хост вместо 2-х SATA SSD. RF = 3, хостов 3.

## Резюме

Медиа-данные постов: 4 nVME + 4 HDD на реплику, 4 хоста на реплику, всего с RF = 3 12 хостов.

Мета-данные постов: 3 хоста по 1 nVME SSD диску.

Комментарии: 3 хоста по 1 HDD.

Реакции: 3 хоста по 1 nVME SSD.
